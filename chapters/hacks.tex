\ExplSyntaxOn
% Force cramped style on inline math
\msg_new:nnn{latexbok}{bad-math}
  {Bad~math~environment~delimiter}
\DeclareDocumentCommand\({}{
  \mode_if_math:T{\msg_error:nn{latexbok}{bad-math}}
  \c_math_toggle_token
  \hbox_set:Nw\l_tmpa_box
}
\DeclareDocumentCommand\){}{
  \hbox_set_end:
  \mode_if_math:F{\msg_error:nn{latexbok}{bad-math}}
  \mode_if_inner:F{\msg_error:nn{latexbok}{bad-math}}
  \cramped{\hbox_unpack_clear:N\l_tmpa_box}
  \c_math_toggle_token
}
% Twoside
\KOMAoptions{twoside}
% Listings
\cs_gset:Npn\kodname{Exempel}
\newcounter{kod}
\cs_set:Npn\thekod{\arabic{kod}}
\cs_new:Npn\fps@kod{tb}
\cs_new:Npn\ftype@kod{3}
\cs_new:Npn\ext@kod{lok}
\cs_new:Npn\fnum@kod{\kodname\ \thekod}
\NewDocumentEnvironment{kod}{o}{
  \__skrapport_xfloat:nx{kod}
    {\IfNoValueTF{#1}{\fps@kod}{#1}}
  \centering
}{
  \end@float
}
\NewDocumentEnvironment{kod*}{o}{
  \__skrapport_xfloat:nx{kod}
    {\IfNoValueTF{#1}{tp}{#1}}
  \centering
}{
  \end@float
}
\newsubfloat{kod}
% Displaying one line of code
\NewDocumentCommand\kodrad{mm}{
  \hspace{1ex}
  \inputminted[firstline=#1,lastline=#1]{latex}{#2.tex}
}
% Redefining sections to break page
\RenewDocumentCommand\section{som}{
  \cleardoublepage
  \vspace*{2\bigskipamount}
  \__skrapport_generic_section:nnnnn{section}{1}{#1}{#2}{#3}
}
% Front/main/backmatter
\NewDocumentCommand\frontmatter{}{
  \cleardoublepage
  \pagenumbering{roman}
}
\NewDocumentCommand\mainmatter{}{
  \cleardoublepage
  \pagenumbering{arabic}
}
\NewDocumentCommand\backmatter{}{
  \cleardoublepage
}
% Changes to titlepage environment (don't reset pagenumbering before)
  \iffalse %TODO
  \renewenvironment{titlepage}{\cleardoublepage}{\thispagestyle{skrapport@titlepage}\cleardoublepage\setcounter{page}\@ne}
  \fi
% TexorPDF version of LaTeX and AmS logo
\cs_generate_variant:Nn\cs_set_nopar:Npn{Npo}
\cs_set_nopar:Npo\LaTeX
  {\exp_args:Non\texorpdfstring{\LaTeX}{LaTeX}}
\cs_set_nopar:Npo\AmS
  {\exp_args:Non\texorpdfstring{\AmS}{AMS}}
% File last modified
%TODO
\def\parsedate #1:2#2#3#4#5#6#7#8#9\empty{\ifx{#2}{9}19\else20\fi#3#4/#5#6/#7#8}
\NewDocumentCommand\moddate{o}{
  \exp_args:Nx\parsedate\pdffilemoddate{
    \IfNoValueTF{#1}{\jobname.tex}{#1}
  }\empty
}
% Minted background fix
\makeatletter
\RenewDocumentEnvironment{minted@colorbg}{m}{
	\par
	\def\minted@bgcol{#1}
	\noindent\begin{lrbox}{\minted@bgbox}
	\begin{minipage}{\linewidth-2\fboxsep}
}{
	\end{minipage}
	\end{lrbox}
	\colorbox{\minted@bgcol}{\usebox{\minted@bgbox}}
	\par
}
\makeatother
\ExplSyntaxOff
